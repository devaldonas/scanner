<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leitor de C√≥digo de Barras e QR</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: #333;
      min-height: 100vh;
    }
    
    .container {
      background: white;
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    h2 {
      color: #333;
      margin-bottom: 20px;
    }
    
    .scanner-container {
      position: relative;
      margin: 20px auto;
      width: 100%;
      max-width: 400px;
    }
    
    video {
      width: 100%;
      border: 3px solid #333;
      border-radius: 12px;
    }
    
    .scanner-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 2px solid #4a00e0;
      border-radius: 12px;
      pointer-events: none;
    }
    
    .scanner-line {
      position: absolute;
      width: 100%;
      height: 2px;
      background: #4a00e0;
      top: 50%;
      animation: scan 2s infinite linear;
    }
    
    @keyframes scan {
      0% { top: 10%; }
      50% { top: 90%; }
      100% { top: 10%; }
    }
    
    .controls {
      margin: 15px 0;
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    
    button {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      background: #4a00e0;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    button:hover {
      background: #2575fc;
    }
    
    button:active {
      transform: scale(0.95);
    }
    
    .btn-stop {
      background: #ff416c;
    }
    
    .btn-clear {
      background: #ff9d00;
    }
    
    #resultado {
      font-size: 18px;
      font-weight: bold;
      color: green;
      margin: 15px 0;
      min-height: 30px;
    }
    
    #erro {
      color: red;
      font-size: 14px;
      margin: 10px 0;
      min-height: 20px;
    }
    
    .status {
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      font-weight: 500;
    }
    
    .status-scanning {
      background: #e3f2fd;
      color: #1565c0;
    }
    
    .counter {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
    }
    
    .total {
      font-size: 1.5rem;
      font-weight: bold;
      color: #4a00e0;
    }
    
    .historico-container {
      margin-top: 20px;
      text-align: left;
    }
    
    #historico {
      list-style: none;
      padding: 0;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
    }
    
    #historico li {
      background: white;
      padding: 10px;
      margin: 5px 0;
      border: 1px solid #eee;
      border-radius: 6px;
      font-family: monospace;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .item-quantity {
      background: #4a00e0;
      color: white;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
    }
    
    .timestamp {
      font-size: 0.8em;
      color: #777;
      margin-top: 5px;
    }
    
    .empty-history {
      text-align: center;
      color: #999;
      font-style: italic;
      padding: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üì∑ Leitor de C√≥digo de Barras e QR Code</h2>
    
    <div class="scanner-container">
      <video id="preview" playsinline></video>
      <div class="scanner-overlay">
        <div class="scanner-line"></div>
      </div>
    </div>
    
    <div id="status" class="status status-scanning">Escaneando... Aponte para um c√≥digo</div>
    <div id="resultado"></div>
    <div id="erro"></div>
    
    <div class="controls">
      <button id="btnStop" class="btn-stop">Parar Scanner</button>
      <button id="btnStart" style="display:none;">Retomar Scanner</button>
      <button id="btnClear" class="btn-clear">Limpar Hist√≥rico</button>
    </div>
    
    <div class="counter">
      <div>Total de Itens Escaneados:</div>
      <div id="total" class="total">0</div>
    </div>
    
    <div class="historico-container">
      <h3>üìã Hist√≥rico de Leituras</h3>
      <ul id="historico">
        <li class="empty-history">Nenhum c√≥digo escaneado ainda</li>
      </ul>
    </div>
  </div>

  <!-- Biblioteca ZXing -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script>
    const codeReader = new ZXing.BrowserMultiFormatReader();
    const video = document.getElementById('preview');
    const resultado = document.getElementById('resultado');
    const erroMsg = document.getElementById('erro');
    const historico = document.getElementById('historico');
    const statusElement = document.getElementById('status');
    const totalElement = document.getElementById('total');
    const btnStop = document.getElementById('btnStop');
    const btnStart = document.getElementById('btnStart');
    const btnClear = document.getElementById('btnClear');
    
    let scanning = true;
    let scannedCodes = {};
    let totalItems = 0;
    let lastScannedCode = '';
    
    // Formatar data e hora
    function formatDateTime(date) {
      return `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
    }
    
    // Atualizar a contagem total
    function updateTotal() {
      totalElement.textContent = totalItems;
    }
    
    // Atualizar o hist√≥rico na tela
    function updateHistory() {
      if (Object.keys(scannedCodes).length === 0) {
        historico.innerHTML = '<li class="empty-history">Nenhum c√≥digo escaneado ainda</li>';
        return;
      }
      
      historico.innerHTML = '';
      for (const code in scannedCodes) {
        const item = scannedCodes[code];
        const li = document.createElement('li');
        
        li.innerHTML = `
          <div>
            <strong>${item.text}</strong>
            <div class="timestamp">${formatDateTime(item.timestamp)}</div>
          </div>
          <div class="item-quantity">${item.quantity}</div>
        `;
        
        historico.appendChild(li);
      }
    }
    
    // Adicionar c√≥digo ao hist√≥rico
    function addToHistory(codeText) {
      // Ignora se for o mesmo c√≥digo escaneado recentemente
      if (codeText === lastScannedCode) {
        return;
      }
      
      lastScannedCode = codeText;
      
      if (scannedCodes[codeText]) {
        // C√≥digo j√° existe, incrementa a quantidade
        scannedCodes[codeText].quantity++;
        scannedCodes[codeText].timestamp = new Date();
      } else {
        // Novo c√≥digo
        scannedCodes[codeText] = {
          text: codeText,
          quantity: 1,
          timestamp: new Date()
        };
      }
      
      totalItems++;
      updateTotal();
      updateHistory();
      
      // Feedback visual
      resultado.textContent = `‚úÖ C√≥digo lido: ${codeText}`;
      statusElement.textContent = "C√≥digo detectado! Continue escaneando...";
      statusElement.style.backgroundColor = "#e8f5e9";
      statusElement.style.color = "#2e7d32";
      
      // Volta ao estado normal ap√≥s 2 segundos
      setTimeout(() => {
        statusElement.textContent = "Escaneando... Aponte para o pr√≥ximo c√≥digo";
        statusElement.style.backgroundColor = "#e3f2fd";
        statusElement.style.color = "#1565c0";
      }, 2000);
    }
    
    // Parar o scanner
    function stopScanner() {
      if (scanning) {
        codeReader.reset();
        scanning = false;
        btnStop.style.display = 'none';
        btnStart.style.display = 'inline-block';
        statusElement.textContent = "Scanner pausado";
        statusElement.style.backgroundColor = "#fff3e0";
        statusElement.style.color = "#ef6c00";
      }
    }
    
    // Iniciar/reiniciar o scanner
    async function startScanner() {
      if (!scanning) {
        try {
          const devices = await codeReader.listVideoInputDevices();
          
          if (devices.length === 0) {
            erroMsg.textContent = "‚ùå Nenhuma c√¢mera encontrada!";
            return;
          }
          
          // Procura a c√¢mera traseira
          let deviceId = devices[0].deviceId;
          const cameraTraseira = devices.find(d => d.label.toLowerCase().includes("back"));
          if (cameraTraseira) {
            deviceId = cameraTraseira.deviceId;
          }
          
          // Inicia a leitura
          await codeReader.decodeFromVideoDevice(deviceId, video, (result, err) => {
            if (result) {
              addToHistory(result.text);
            }
          });
          
          scanning = true;
          btnStop.style.display = 'inline-block';
          btnStart.style.display = 'none';
          statusElement.textContent = "Escaneando... Aponte para um c√≥digo";
          statusElement.style.backgroundColor = "#e3f2fd";
          statusElement.style.color = "#1565c0";
          erroMsg.textContent = "";
          
        } catch (error) {
          erroMsg.textContent = "‚ùå Erro ao acessar a c√¢mera: " + error.message;
        }
      }
    }
    
    // Limpar hist√≥rico
    function clearHistory() {
      scannedCodes = {};
      totalItems = 0;
      lastScannedCode = '';
      updateTotal();
      updateHistory();
      resultado.textContent = "";
      statusElement.textContent = "Hist√≥rico limpo. Aponte para um c√≥digo";
    }
    
    // Event listeners para os bot√µes
    btnStop.addEventListener('click', stopScanner);
    btnStart.addEventListener('click', startScanner);
    btnClear.addEventListener('click', clearHistory);
    
    // Iniciar o scanner quando a p√°gina carregar
    startScanner();
  </script>
</body>
</html>
